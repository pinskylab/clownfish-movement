---
title: "Creating convex hulls"
output: html_notebook
---
Create convex hulls of clownfish fish movement.

```{r setup}
# load libraries
library(tidyverse)

# load functions
source("~/db-connections.R")

# connect to databases
leyte <- read_db("Leyte")

# load data
fish_db <- leyte %>% 
  tbl("clownfish") %>% 
  collect()

anem_db <- leyte %>% 
  tbl("anemones") %>% 
  collect() 

dive_db <- leyte %>% 
  tbl("diveinfo") %>% 
  collect()

# read in data generated by anemone_locations.Rmd in the clownfish demographics package
# the point average through the years for each anem_obs
anem_obs_locs <- read_csv("https://raw.githubusercontent.com/pinskylab/clownfish-demographics/master/data/anem_obs_locations.csv?token=AG664YK6XDA4N5PEEBR6LKS5YMCP6")

# read in data generated by the genomics project, in the protocols folder, scripts 5-7 (remove-regenos through recaptured fish).  The fish_indiv column connects all observations of a fish.
fish_indiv <- read_csv("https://raw.githubusercontent.com/pinskylab/genomics/master/data/fish-obs.csv", col_types = cols(.default = col_character())) 

```

Pull fish who have an indiv and add location and date data
```{r fish_anem}
fish_anem <- fish_db %>% 
  
  # select columns
  select(fish_table_id, anem_table_id, sample_id, tag_id, size, color, sex) %>% 
  
  # connect to fish_indiv
  left_join(mutate(fish_indiv, fish_table_id = as.numeric(fish_table_id)), by = c("fish_table_id", "sample_id", "tag_id")) %>% 
  
  # remove fish without an identity
  filter(!is.na(fish_indiv))%>% 

  
  # join to anemone observations
  left_join(select(anem_db, anem_table_id, dive_table_id, anem_id, anem_obs), by = "anem_table_id") %>% 
  
  # join to diveinfo for date and site info
  left_join(select(dive_db, dive_table_id, date, site), by = "dive_table_id") %>% 
  
  # remove rows without an anem_id
  filter(!is.na(anem_id)) %>% 
  
  
  # add anem_obs locations
  left_join(anem_obs_locs, by = "anem_obs") %>% 
  rename(anem_obs_lat = lat, 
         anem_obs_lon = lon) %>% 
  
  # consolidate the columns into one location
  mutate(lat = ifelse(is.na(anem_obs_lat), anem_id_lat, anem_obs_lat), 
         lon = ifelse(is.na(anem_obs_lon), anem_id_lon, anem_obs_lon)) %>% 
  
  # deselect columns
  select(-contains("anem_obs_l"), 
         -contains("anem_id_l"))

```

For area analyses, select only fish that have been captured on more than 2 anemones
```{r area_fish}
area_fish <- fish_anem %>% 
  # select(fish_indiv, lat, lon) %>%
  select(fish_indiv, lat, lon, site) %>%
  distinct() %>% 
  group_by(fish_indiv) %>% 
  filter(n() > 2) %>% 
  ungroup()

```


# Make one giant leaflet outline - not our solution
Solution from https://github.com/ropensci/mapr/issues/23 & https://rstudio.github.io/leaflet/showhide.html
```{r original, eval=FALSE}
outline <- quakes[chull(quakes$long, quakes$lat),]

map <- leaflet(quakes) %>%
  # Base groups
  addTiles(group = "OSM (default)") %>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # Overlay groups
  addCircles(~long, ~lat, ~10^mag/5, stroke = F, group = "Quakes") %>%
  addPolygons(data = outline, lng = ~long, lat = ~lat,
    fill = F, weight = 2, color = "#FFFFCC", group = "Outline") %>%
  # Layers control
  addLayersControl(
    baseGroups = c("OSM (default)", "Toner", "Toner Lite"),
    overlayGroups = c("Quakes", "Outline"),
    options = layersControlOptions(collapsed = FALSE)
  )
map

```

# This solution doesn't work because leaflet doesn't allow multiple layers at a time, or does it?
```{r mine, eval=FALSE}
library(leaflet)


map <- leaflet(hull) %>%
  # Base groups
  addTiles(group = "OSM (default)") %>%
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Toner Lite") %>%
  # Overlay groups
  addCircles(~lon, ~lat, stroke = F, group = "fish_indiv") %>%
  addPolygons(data = outline, lng = ~lon, lat = ~lat,
    fill = F, weight = 2, color = "#FFFFCC", group = "Outline") %>%
  # Layers control
  addLayersControl(
    baseGroups = c("OSM (default)", "Toner", "Toner Lite"),
    overlayGroups = c("fish_indiv", "Outline"),
    options = layersControlOptions(collapsed = FALSE)
  )
map
```

https://github.com/ropensci/mapr/issues/23 - June 14, 2016 solution from sckott
```{r eval=FALSE}
devtools::install_github("ropensci/mapr@dev")
library(mapr)


map_leaflet(x = fish_anem, lon = fish_anem$lon, lat = fish_anem$lat)
```
# plotting in ggplot works but is too zoomed out.
Trying this solution:https://stackoverflow.com/questions/48690755/adding-convex-hull-to-ggplot-map
```{r}
hull <- area_fish %>% 
      group_by(fish_indiv) %>% 
      slice(chull(lon, lat))

# how many fish are there?
num_fish <- area_fish %>% 
  distinct(fish_indiv)

# Define the scatterplot
p <- ggplot(area_fish, aes(lon, lat)) + geom_point(shape = 21)

# Overlay the convex hull
p + geom_polygon(data = hull, alpha = 0.5)

# Update the plot with a fill group, and overlay the new hulls
q <- p + aes(fill = factor(fish_indiv)) + geom_polygon(data = hull, alpha = 0.5) + guides(fill = "none")

# try zooming
q + coord_cartesian(xlim = c(124.7106, 124.7107), ylim = c(10.874, 10.8745))

#write the hulls to csv to import into QGIS
write_csv(hull, here::here("data", "fish-hulls.csv"))
```

