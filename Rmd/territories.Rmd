---
title: "Territories"
output: html_notebook
---
```{r setup}
# load libraries
library(tidyverse)
library(purrr)
library(sf) # for calculating the area of a polygon
# library(concaveman) # for making convex hulls
library(tmap) # for making maps of convex hulls
library(ggthemes) # for making maps
library(igraph) # for making convex hulls

# load functions
source("~/db-connections.R")

# connect to databases
leyte <- read_db("Leyte")

# load data
fish_db <- leyte %>% 
  tbl("clownfish") %>% 
  collect()

anem_db <- leyte %>% 
  tbl("anemones") %>% 
  collect() 

dive_db <- leyte %>% 
  tbl("diveinfo") %>% 
  collect()

# read in data generated by anemone_locations.Rmd in the clownfish demographics package
# the point average through the years for each anem_obs
anem_obs_locs <- read_csv("https://raw.githubusercontent.com/pinskylab/clownfish-demographics/master/data/anem_obs_locations.csv?token=AG664YPBYND45ZH7XITOOTC5ROJJC")

# read in data generated by the genomics project, in the protocols folder, scripts 5-7 (remove-regenos through recaptured fish).  The fish_indiv column connects all observations of a fish.
fish_indiv <- read_csv("https://raw.githubusercontent.com/pinskylab/genomics/master/data/fish-obs.csv", col_types = cols(.default = col_character())) 

```

## 1. What anemones do fish visit?
Only searching for fish we have recaptured
```{r}
fish_anem <- fish_db %>% 
  
  # select columns
  select(fish_table_id, anem_table_id, sample_id, tag_id, size, color, sex) %>% 
  
  # connect to fish_indiv
  left_join(mutate(fish_indiv, fish_table_id = as.numeric(fish_table_id)), by = c("fish_table_id", "sample_id", "tag_id")) %>% 
  
  # remove fish without an identity
  filter(!is.na(fish_indiv))%>% 

  
  # join to anemone observations
  left_join(select(anem_db, anem_table_id, dive_table_id, anem_id, anem_obs), by = "anem_table_id") %>% 
  
  # join to diveinfo for date and site info
  left_join(select(dive_db, dive_table_id, date, site), by = "dive_table_id") %>% 
  
  # remove rows without an anem_id
  filter(!is.na(anem_id)) %>% 
  
  
  # add anem_obs locations
  left_join(anem_obs_locs, by = "anem_obs") %>% 
  rename(anem_obs_lat = lat, 
         anem_obs_lon = lon) %>% 
  
  # consolidate the columns into one location
  mutate(lat = ifelse(is.na(anem_obs_lat), anem_id_lat, anem_obs_lat), 
         lon = ifelse(is.na(anem_obs_lon), anem_id_lon, anem_obs_lon)) %>% 
  
  # deselect columns
  select(-contains("anem_obs_l"), 
         -contains("anem_id_l"))

```

# create convex hulls for each fish that was captured more than twice
```{r}
# select fish that have been captured on more than 2 anemones
area_fish <- fish_anem %>% 
  # select(fish_indiv, lat, lon) %>%
  select(fish_indiv, lat, lon, site) %>%
  distinct() %>% 
  group_by(fish_indiv) %>% 
  filter(n() > 2) %>% 
  ungroup()


 # suggested solution # 15 - https://stackoverflow.com/questions/48690755/adding-convex-hull-to-ggplot-map
    hull <- area_fish %>% 
      group_by(fish_indiv) %>% 
      slice(chull(lon, lat))
    
    # try one individual, might be that this is too zoomed out
    one_site <- area_fish %>% 
      filter(site == "Palanas") 
    hull <- one_site%>% 
      slice(chull(lon, lat))
    
    p <- ggplot(one_site, aes(lon, lat)) + geom_point(shape = 21)
    p + aes(fill = factor(fish_indiv)) + geom_polygon(data = hull, alpha = 0.5)
    # The problem is that it is too zoomed out.  Try by site?
    


test <- area_fish %>% 
  group_by(fish_indiv) %>% 
  nest() %>% 
  mutate(
    # hull = map(data, ~with(.x, chull(lon, lat))), # this is no different than area_fish arranged by fish_indiv
   
    
    # ---------- NOT WORKING AT ALL --------------
    # hull = map(data, ~with(as.matrix(.x), concave_hull(.x))), # Error in eval(substitute(expr), data, enclos = parent.frame()) : numeric 'envir' arg not of length one
    # hull = map(data, ~with(.x, concave_hull(lon, lat))), # wants only one argument that is a matrix of points
    # hull = map(data, ~with(.x, concaveman(as.matrix(.)))), # this line makes out populate with NAs and makes unnest fail
    # hull = map(data, ~as.matrix(.x), concaveman::concaveman(.x)), # also causes out and unnest to fail
    out = map2(data, hull, ~.x[.y,,drop=FALSE])) %>% 
  select(-data) %>% 
  unnest()


test1 <- area_fish %>% 
  arrange(fish_indiv)

# plot chull and original polygons
# ggplot(test, aes(lon, lat)) +
#   geom_polygon(alpha = 0.2) +
#   geom_polygon(data = area_fish, alpha = 0.2)

# try a for loop with convex_hull and a matrix - not sure what to do with the results of this
# fishes <- distinct(area_fish, fish_indiv)
# 
# for(i in seq_along(fishes$fish_indiv)){
#   this_fish <- area_fish %>% 
#     filter(fish_indiv == fishes$fish_indiv[i]) %>% 
#     select(-fish_indiv)
#   hull <- convex_hull(as.matrix(this_fish))
# }

# from oceanadapt
hullpts <-  chull(x=lon, y=lat) # find indices of vertices
  hullpts = c(hullpts,hullpts[1]) # close the loop
  lonlat <- data.frame(cbind(lon, lat))
  ps = appendPolys(NULL,mat=as.matrix(lonlat[hullpts,]),1,1,FALSE) # create a Polyset object
  attr(ps,"projection") = "LL" # set projection to lat/lon
  psUTM = convUL(ps, km=TRUE) # convert to UTM in km
  polygonArea = calcArea(psUTM,rollup=1)
  return(polygonArea$area)


# plot(test$hull, x= )

```


# tried concaveman but couldn't get it to work
```{r eval=FALSE}

fishes <- distinct(area_fish, fish_indiv)
hulls <- tibble()
for (i in seq_along(fishes$fish_indiv)){
  by_fish <- area_fish %>% 
    filter(fish_indiv == fishes$fish_indiv[i]) %>% 
    select(-fish_indiv)
  hull <- concaveman(as.matrix(by_fish))
  test <- cbind(area_fish)
  hulls <- c(hulls, hull)
  
  ggplot(by_fish, aes(lon, lat)) +
    tm_shape(by_fish, is.master = TRUE) +
    tm_dots(size = 0.2, col = "orange") +
    tm_shape(hull) + tm_borders(lwd = 2)
}
```





# What is the area occupied by each fish that has been captured more than once
```{r}
temp <- fish_anem %>% 
  group_by(fish_indiv) %>% 
  filter(n() > 1)

recaps <- unique(temp$fish_indiv)

area_results <- tibble() 

for (i in seq_along(recaps)){
  x <- filter(fish_anem, fish_indiv == recaps[i])
  
  # create a table of locations
  df <- tibble(lon = x$lon, lat = x$lat)
  
  # close the polygon by adding the first line again
  df <- rbind(df, df[1, ])
  
  poly <- st_sf(st_sfc(st_polygon(list(as.matrix(df)))), crs = 4326)


  y <- tibble(fish_indiv = x$fish_indiv[1], home_range = st_area(poly), site = x$site)
  
  # remove the units from the home_range
  y$home_range <- unclass(y$home_range)
  
  
  area_results <- bind_rows(area_results, y) %>% 
    # distinct(fish_indiv, site, .keep_all = T) %>% 
    arrange(desc(home_range)) %>% 
    distinct()
  
  
}

(base::summary(area_results))
```
# There are some extreme outliers in this data set.  

Fish_indiv 1665 has tag_id 982000411818464 and was seen on 4 different anemones in Wangag.  
```{r}
# everything looks ok, all in the same site.
fish1 <- fish_anem %>% 
  filter(fish_indiv == 1665)

 # create a table of locations
  locs <- tibble(lon = fish1$lon, lat = fish1$lat)
  
  # close the polygon by adding the first line again
  locs <- rbind(locs, locs[1, ])
  
  poly <- st_sf(st_sfc(st_polygon(list(as.matrix(locs)))), crs = 4326)
  
  territory <- tibble(home_range = st_area(poly))
  
# what about observations of the anemone that is farther away?
  anem_1 <- anem_db %>% 
    filter(anem_id == 2560)

```

